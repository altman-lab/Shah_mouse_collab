---
title: "Gene set enrichment analysis (GSEA)"
author: "Kim Dill-McFarland, kadm@uw.edu"
date: "version `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
subtitle: J. Shah chimeric mouse collaboration
always_allow_html: yes
---
# Background

The purpose of this workflow is to determine which Broad Molecular Signature Database (MSigDB) terms are enriched in significant and modules from WCGNA analysis.

# Setup
Load packages

```{r message=FALSE, warning=FALSE}
# Data manipulation and figures
library(tidyverse)

#Print pretty tables to Rmd
library(knitr)
library(kableExtra)

`%notin%` <- Negate(`%in%`)
```

Set seed

```{r}
set.seed(4389)
```

# Load data

```{r results.data, message=FALSE, warning=FALSE}
#Gene results
Shah_contrast_gene_pval <-
  read_csv("results/gene_level/Shah_contrast_gene_pval.csv")
#Module results
mods.net <- read_csv("results/module_Shah_contrast_deepSplit3_minMod50/Shah_contrast_genes_in_mod.csv")

#Genome
library(org.Mm.eg.db)
#Script for running GSEA
source("scripts/GSEA_enricher.R")
```

# Gene set enrichment analysis (GSEA)
Gene ontology ([GO](http://geneontology.org/)) provides gene functions and annotations from a variety of sources. Specifics on the gene sets below can be found at <http://software.broadinstitute.org/gsea/msigdb/collections.jsp>.

## Gene set descriptions

* Hallmark gene sets (H)
    - Hallmark gene sets summarize and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression. 
* Basic gene sets (C5)
    - Gene sets that contain genes annotated by the same GO term. Includes:
    - BP: biological process
    - CC: cellular component
    - MF: molecular function
* Curated gene sets (C2)
    - Gene sets curated from various sources including online pathway databases, the biomedical literature, and knowledge of domain experts. Includes:
    - CGP: chemical and genetic perturbations
    - CP: Canonical pathways
        * BIOCARTA: BioCarta gene sets
        * KEGG: KEGG gene sets
        * PID: PID gene sets
        * REACTOME: Reactome gene sets
* Immunologic signatures (C7)
    - Gene sets that represent cell states and perturbations within the immune system. The signatures were generated by manual curation of published studies in human and mouse immunology.    

## GSEA gene-level

List genes with FDR < 0.05

```{r}
gene.list <- Shah_contrast_gene_pval %>% 
  filter(adj.P.Val <= 0.05) %>% 
  dplyr::select(geneName) %>% unlist(use.names = FALSE)
```

```{r warning=FALSE, message=FALSE, results=FALSE}
#Run custom function on genes
enrich.fxn(gene.list = gene.list,
           category = "H", genome = org.Mm.eg.db,
           basename="contrast_signif_genes")

#### Other gene sets not run ####
#enrich.fxn(gene.list = gene.list,
#           category = "C5", genome = org.Mm.eg.db,
#           basename="contrast_signif_genes")

#enrich.fxn(gene.list = gene.list,
#           category = "C2", subcategory = "CGP", genome = org.Mm.eg.db,
#           basename="contrast_signif_genes")

#enrich.fxn(gene.list = gene.list,
#           category = "C2", subcategory = "CP:KEGG", genome = org.Mm.eg.db,
#           basename="contrast_signif_genes")

#enrich.fxn(gene.list = gene.list,
#           category = "C7", genome = org.Mm.eg.db,
#           basename="contrast_signif_genes")
```

### GSEA gene-level summary

Significant enrichments, FDR $\leq$ 0.2.

```{r warning=FALSE, echo=FALSE}
GSEA.results <- bind_rows(mget(ls(pattern="contrast_signif_genes"))) %>% 
  dplyr::select(Description, Count, p.adjust, category) %>% 
  arrange(category, desc(Count))
  
GSEA.results %>% 
  filter(p.adjust<=0.2) %>% 
  dplyr::select(-category) %>% 
  
  kable(col.names = c("Description", "Overlap genes",
                      "FDR")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

## GSEA module-level

List genes in each module.

```{r warning=FALSE, message=FALSE, results=FALSE}
gsea.temp <- data.frame()

for(i in 0:max(mods.net$module)){
  gene.list <- mods.net %>% 
    filter(module == i) %>% 
    dplyr::select(geneName) %>% unlist(use.names = FALSE)
  
  #Run custom function on genes
  enrich.fxn(gene.list = gene.list,
           category = "H", genome = org.Mm.eg.db,
           basename="module_genes")
  
  #### Other gene sets not run ####
  #enrich.fxn(gene.list = gene.list,
  #         category = "C5", genome = org.Mm.eg.db,
  #         basename="module_genes")

  #enrich.fxn(gene.list = gene.list,
  #         category = "C2", subcategory = "CGP", genome = org.Mm.eg.db,
  #         basename="module_genes")

  #enrich.fxn(gene.list = gene.list,
  #         category = "C2", subcategory = "CP:KEGG", 
  #         genome = org.Mm.eg.db,
  #         basename="module_genes")

  #enrich.fxn(gene.list = gene.list,
  #         category = "C7", genome = org.Mm.eg.db,
  #         basename="module_genes")
  
  for(file in list.files(path="results/GSEA/",
                         pattern="module_genes",
                         full.names = TRUE)){
    gsea.temp <- bind_rows(gsea.temp, read_csv(file))
    
  }
  
  #Add module ID column
  if("module" %in% colnames(gsea.temp)){
    gsea.temp <- gsea.temp %>% 
                 mutate(module = ifelse(is.na(module), i, module))
  } else{
    gsea.temp <- gsea.temp %>% 
                 mutate(module = i)
  }
  
}

#Save
for(db in unique(gsea.temp$category)){
  if(db != "C2"){
    gsea.sub <- gsea.temp %>% 
                filter(category == db)
  
    filename <- paste("results/GSEA/GSEA_module_genes_", 
                      db, ".csv", sep="")
    write_csv(gsea.sub, filename)
  
  } else{
    gsea.sub <- gsea.temp %>% 
                filter(category == db)
    for(db.sub in unique(gsea.sub$subcategory)){
      gsea.sub <- gsea.sub %>% 
                filter(subcategory == db.sub)
      
      filename <- paste("results/GSEA/GSEA_module_genes_", 
                      db,"_", db.sub, ".csv", sep="") %>% 
        gsub(":",".",.)
      write_csv(gsea.sub, filename)
      }
  }
}
```

### GSEA module-level summary

Significant enrichments, FDR $\leq$ 0.2.

```{r warning=FALSE, echo=FALSE, message=FALSE}
file <- list.files(path="results/GSEA/", pattern="module_genes",
                    full.names = TRUE)

GSEA.results2 <- read_csv(file) %>% 
  dplyr::select(Description, Count, p.adjust, category,
                module) %>% 
  arrange(category, desc(Count))
  
GSEA.results2 %>% 
  mutate(module=factor(module)) %>% 
  filter(p.adjust<=0.2) %>% 
  group_by(module, .drop = FALSE) %>% 
  dplyr::select(module, everything(), -category) %>% 
  arrange(module, p.adjust) %>% 
  
  kable(col.names = c("Module", "Description",
                      "Overlap genes", "FDR")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>% 
  collapse_rows(columns = 1, valign = "top")
```

## GSEA module DE groups

Groups are:

1. Up in uninfected only
2. Down in uninfected only
3. Up in infected only
4. Down in infected only
5. Up in both
6. Down in both

### Group genes in module 0

Group genes with FDR < 0.3 in 6 module groups of interest.

```{r}
mod_0 <- Shah_contrast_gene_pval %>% 
  filter(geneName %in% filter(mods.net, module == 0)$geneName &
           adj.P.Val <= 0.3)

mod_0_UI_up <- mod_0 %>% 
  filter(group == "uninfected" & FC.group == "up") %>% 
  dplyr::select(geneName) %>% 
  distinct(geneName) %>%  unlist(use.names = FALSE)
mod_0_UI_down <- mod_0 %>% 
  filter(group == "uninfected" & FC.group == "down") %>% 
  dplyr::select(geneName) %>% 
  distinct(geneName) %>%  unlist(use.names = FALSE)

mod_0_I_up <- mod_0 %>% 
  filter(group == "infected" & FC.group == "up") %>% 
  dplyr::select(geneName) %>% 
  distinct(geneName) %>%  unlist(use.names = FALSE)
mod_0_I_down <- mod_0 %>% 
  filter(group == "infected" & FC.group == "down") %>% 
  dplyr::select(geneName) %>% 
  distinct(geneName) %>%  unlist(use.names = FALSE)

mod_0_both_up <- intersect(mod_0_UI_up, mod_0_I_up)
mod_0_both_down <- intersect(mod_0_UI_down, mod_0_I_down)

mod_0_UI_up2 <- mod_0_UI_up[mod_0_UI_up %notin% 
                          c(mod_0_UI_down,
                            mod_0_I_up, mod_0_I_down)]
mod_0_UI_down2 <- mod_0_UI_down[mod_0_UI_down %notin% 
                           c(mod_0_UI_up,
                            mod_0_I_up, mod_0_I_down)]
  
mod_0_I_up2 <- mod_0_I_up[mod_0_I_up %notin% 
                           c(mod_0_UI_up, mod_0_UI_down,
                            mod_0_I_down)]
mod_0_I_down2 <- mod_0_I_down[mod_0_I_down %notin% 
                            c(mod_0_UI_up, mod_0_UI_down,
                            mod_0_I_up)]
```

Sort genes that have different fold change directions in uninfected vs. infected. If one infection group is significant at FDR < 0.1, use that for grouping.

```{r}
#Check genes not in a group
all <- c(mod_0_UI_up, mod_0_UI_down, mod_0_I_up, mod_0_I_down)
all2 <- c(mod_0_both_up, mod_0_both_down,
          mod_0_UI_up2, mod_0_UI_down2, 
          mod_0_I_up2, mod_0_I_down2)

missing <- mod_0 %>% 
  filter(geneName %in% all[all %notin% all2]) %>% 
  arrange(geneName, adj.P.Val)

#Sort my hand
mod_0_UI_up <- c(mod_0_UI_up2)
mod_0_UI_down <- c(mod_0_UI_down2)
mod_0_I_up <- c(mod_0_I_up2, "ENSMUSG00000024935","ENSMUSG00000027534")
mod_0_I_down <- c(mod_0_I_down2)

#Save lists
save(mod_0_UI_up, mod_0_UI_down, mod_0_I_up, mod_0_I_down,
     mod_0_both_up, mod_0_both_down,
      file="data_clean/module_0_sorted.RData")
```

These leaves 8 module 0 genes which were not grouped into a module FC group because they showed similarly significant but different directions in uninfected and infected groups.

```{r}
missing %>% 
  filter(geneName %notin% c("ENSMUSG00000024935",
                            "ENSMUSG00000027534")) %>% 
  dplyr::select(geneName, mgi_symbol, adj.P.Val, group, FC.group) %>% 
  
 kable() %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>% 
  collapse_rows(columns = 1:2, valign = "top")
```

### Run GSEA

```{r warning=FALSE, message=FALSE, results=FALSE}
file.remove("results/GSEA/GSEA_module_groups_H.csv", showWarnings=FALSE)
#Add groups to modules
mods.net.groups <- mods.net %>% 
  mutate(mod.group = ifelse(module %in% c(14,7,16,9), "both_up",
                      ifelse(module %in% c(5,11,17,10,2), "both_down",
                       ifelse(module %in% c(13,15), "UI_up",
                        ifelse(module %in% c(6,12), "UI_down",
                          ifelse(module %in% c(1,3), "I_up",
                            ifelse(module %in% c(4,8), "I_down",
                                   NA))))))) %>% 
  filter(module != 0)

for(mod.group.name in c("both_up", "both_down",
              "UI_up", "UI_down", 
              "I_up", "I_down")){
  
  from_mods <- mods.net.groups %>% 
    filter(mod.group == mod.group.name) %>% 
    dplyr::select(geneName) %>% 
    distinct() %>% unlist(use.names = FALSE)
    
  from_mod0 <- get(paste("mod_0", mod.group.name, sep="_"))
  
  gene.list.all <- unique(c(from_mods, from_mod0))
  
  #Run custom function on genes
  enrich.fxn(gene.list = gene.list.all,
           category = "H", genome = org.Mm.eg.db,
           basename=paste(mod.group.name, length(gene.list.all), sep="_"))
}

#Combine results
files <- list.files(path="results/GSEA/",
                         pattern="down|up",
                         full.names = TRUE)

gsea.result3 <- data.frame()
for(i in 1:length(files)){
  group.name <- gsub("results/GSEA//GSEA_", "", files[i])
  group.name <- gsub("_H.csv", "", group.name)
  group.name <- gsub("UI_", "uninfected_", group.name)
  group.name <- gsub("I_", "infected_", group.name)
  
  gsea.temp <- read_csv(files[i]) %>% 
    #Add module group name
    mutate(mod.group = group.name) %>% 
    #Get number of genes from name
    separate(mod.group, into=c("mod.group","size.mod.group"), 
             sep="_(?=[^_]+$)") %>% 
    #Extract values from ratios
    separate(BgRatio, into=c("size.term","size.category"), sep="/") %>% 
    separate(GeneRatio, into=c("size.overlap.term","size.overlap.category"),
             sep="/") %>% 
    mutate_at(vars("size.term","size.category",
                   "size.overlap.term","size.overlap.category"),
                   as.numeric) %>% 
    #Calculate k/K
    mutate("k/K"=size.overlap.term/size.term) %>% 
    
    #Reorder variables
    dplyr::select(category, mod.group, 
                  size.mod.group, size.overlap.category, size.category,
                  Description, size.overlap.term, size.term, `k/K`,
                  p.adjust, ENTREZIDs:ENSEMBLIDs) %>% 
    arrange(p.adjust)
  
 gsea.result3 <- bind_rows(gsea.result3, gsea.temp) 
}

#Save to disk
write_csv(gsea.result3, "results/GSEA/GSEA_module_groups_H.csv")

file.remove(files, showWarnings=FALSE)
```

### GSEA module group summary

Significant enrichments, FDR $\leq$ 0.2.

```{r warning=FALSE, echo=FALSE, message=FALSE}
gsea.result3 %>% 
  filter(p.adjust<=0.2) %>% 
  arrange(mod.group) %>%
  dplyr::select(mod.group, size.mod.group,
                Description:p.adjust) %>% 
 
  kable(col.names = c("Module group", "Genes in module group",
                      "Description", "Genes in overlap (k)", 
                      "Genes in term (K)", "k/K",
                      "FDR")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>% 
  collapse_rows(columns = 1:2, valign = "top")
```

# R session

```{r}
sessionInfo()
```

***