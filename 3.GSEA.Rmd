---
title: "Gene set enrichment analysis (GSEA)"
subtitle: "J. Shah chimeric mouse collaboration"
author: "Kim Dill-McFarland, kadm@uw.edu"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
date: "version `r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  chunk_output_type: console
---
# Background

The purpose of this workflow is to determine which Broad Molecular Signature Database (MSigDB) terms are enriched in significant and modules from WCGNA analysis.

# Setup
Load packages

```{r message=FALSE, warning=FALSE}
# Data manipulation and figures
library(tidyverse)

#Print pretty tables to Rmd
library(knitr)
library(kableExtra)
```

Set seed

```{r}
set.seed(4389)
```

# Load data

```{r results.data}
#Gene results
Shah_contrast_gene_pval <-
  read_csv("results/gene_level/Shah_contrast_gene_pval.csv")
#Genome
library(org.Mm.eg.db)
#Script for running GSEA
source("scripts/GSEA_enricher.R")
```

# Gene set enrichment analysis (GSEA)
Gene ontology ([GO](http://geneontology.org/)) provides gene functions and annotations from a variety of sources. Specifics on the gene sets below can be found at <http://software.broadinstitute.org/gsea/msigdb/collections.jsp>.

## Gene set descriptions

* Hallmark gene sets (H)
    - Hallmark gene sets summarize and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression. 
* Basic gene sets (C5)
    - Gene sets that contain genes annotated by the same GO term. Includes:
    - BP: biological process
    - CC: cellular component
    - MF: molecular function
* Curated gene sets (C2)
    - Gene sets curated from various sources including online pathway databases, the biomedical literature, and knowledge of domain experts. Includes:
    - CGP: chemical and genetic perturbations
    - CP: Canonical pathways
        * BIOCARTA: BioCarta gene sets
        * KEGG: KEGG gene sets
        * PID: PID gene sets
        * REACTOME: Reactome gene sets
* Immunologic signatures (C7)
    - Gene sets that represent cell states and perturbations within the immune system. The signatures were generated by manual curation of published studies in human and mouse immunology.    

## GSEA of all significant genes

List genese with FDR < 0.05

```{r}
gene.list <- Shah_contrast_gene_pval %>% 
  filter(adj.P.Val <= 0.05) %>% 
  dplyr::select(geneName) %>% unlist(use.names = FALSE)
```

```{r warning=FALSE}
#Run custom function on genes
enrich.fxn(gene.list = gene.list,
           category = "H", genome = org.Mm.eg.db,
           basename="contrast_signif_genes")

enrich.fxn(gene.list = gene.list,
           category = "C5", genome = org.Mm.eg.db,
           basename="contrast_signif_genes")

enrich.fxn(gene.list = gene.list,
           category = "C2", subcategory = "CGP", genome = org.Mm.eg.db,
           basename="contrast_signif_genes")

enrich.fxn(gene.list = gene.list,
           category = "C2", subcategory = "CP:KEGG", genome = org.Mm.eg.db,
           basename="contrast_signif_genes")

enrich.fxn(gene.list = gene.list,
           category = "C7", genome = org.Mm.eg.db,
           basename="contrast_signif_genes")
```

## GSEA summary

Significant enrichments, FDR $\leq$ 0.05.

```{r warning=FALSE, echo=FALSE}
GSEA.results <- bind_rows(get(ls(pattern="contrast_signif_genes"))) %>% 
  dplyr::select(Description, Count, p.adjust, category, subcategory) %>% 
  arrange(category, subcategory, desc(Count))
  
GSEA.results %>% 
  filter(p.adjust<=0.05) %>% 
  group_by(category, subcategory) %>% 
  tally() %>%
  
  kable(align=c("l","l","c"), 
        col.names = c("Category", "Subcategory", "Significant terms")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

# R session

```{r}
sessionInfo()
```

***