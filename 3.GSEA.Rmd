---
title: "Gene set enrichment analysis (GSEA)"
author: "Kim Dill-McFarland, kadm@uw.edu"
date: "version `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
subtitle: J. Shah chimeric mouse collaboration
always_allow_html: yes
---
# Background

The purpose of this workflow is to determine which Broad Molecular Signature Database (MSigDB) terms are enriched in significant and modules from WCGNA analysis.

# Setup
Load packages

```{r message=FALSE, warning=FALSE}
# Data manipulation and figures
library(tidyverse)

#Print pretty tables to Rmd
library(knitr)
library(kableExtra)

`%notin%` <- Negate(`%in%`)
```

Set seed

```{r}
set.seed(4389)
```

# Load data

```{r results.data, message=FALSE, warning=FALSE}
#Gene results
Shah_contrast_gene_pval <-
  read_csv("results/gene_level/Shah_contrast_gene_pval.csv")
#Module results
mods.net <- read_csv("results/module_Shah_contrast_deepSplit3_minMod50/Shah_contrast_genes_in_mod.csv")

#Genome
library(org.Mm.eg.db)
#Script for running GSEA
source("https://raw.githubusercontent.com/kdillmcfarland/R_bioinformatic_scripts/master/GSEA_enricher_loop.R")
```

# Gene set enrichment analysis (GSEA)
Gene ontology ([GO](http://geneontology.org/)) provides gene functions and annotations from a variety of sources. Specifics on the gene sets below can be found at <http://software.broadinstitute.org/gsea/msigdb/collections.jsp>.

## Gene set descriptions

* Hallmark gene sets (H)
    - Hallmark gene sets summarize and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression. 
* Basic gene sets (C5)
    - Gene sets that contain genes annotated by the same GO term. Includes:
    - BP: biological process
    - CC: cellular component
    - MF: molecular function
* Curated gene sets (C2)
    - Gene sets curated from various sources including online pathway databases, the biomedical literature, and knowledge of domain experts. Includes:
    - CGP: chemical and genetic perturbations
    - CP: Canonical pathways
        * BIOCARTA: BioCarta gene sets
        * KEGG: KEGG gene sets
        * PID: PID gene sets
        * REACTOME: Reactome gene sets
* Immunologic signatures (C7)
    - Gene sets that represent cell states and perturbations within the immune system. The signatures were generated by manual curation of published studies in human and mouse immunology.    

## GSEA gene-level

List genes with FDR < 0.05

```{r}
gene.list <- Shah_contrast_gene_pval %>% 
  filter(adj.P.Val <= 0.05) %>% 
  dplyr::select(geneName) %>% unlist(use.names = FALSE)
```

```{r warning=FALSE, message=FALSE, results=FALSE}
#Run custom function on genes
enrich.fxn(gene.list = list(contrast_signif_genes=gene.list),
           category = "H", genome = org.Mm.eg.db,
           basename="contrast_signif_genes")

#### Other gene sets not run ####
#enrich.fxn(gene.list = gene.list,
#           category = "C5", genome = org.Mm.eg.db,
#           basename="contrast_signif_genes")

#enrich.fxn(gene.list = gene.list,
#           category = "C2", subcategory = "CGP", genome = org.Mm.eg.db,
#           basename="contrast_signif_genes")

#enrich.fxn(gene.list = gene.list,
#           category = "C2", subcategory = "CP:KEGG", genome = org.Mm.eg.db,
#           basename="contrast_signif_genes")

#enrich.fxn(gene.list = gene.list,
#           category = "C7", genome = org.Mm.eg.db,
#           basename="contrast_signif_genes")
```

### GSEA gene-level summary

Significant enrichments, FDR $\leq$ 0.2.

```{r warning=FALSE, echo=FALSE}
GSEA.results <- read_csv("results/GSEA/GSEA_contrast_signif_genes_H.csv") 

GSEA.results %>% 
  filter(p.adjust<=0.2) %>% 
  dplyr::select(group, size.group,
    Description, size.overlap.term, size.term, 
    p.adjust) %>% 
  arrange(group, p.adjust) %>% 
  
  kable(col.names = c("Group", "Genes in group",
                      "Description", "Genes overlap",
                      "Genes in term",
                      "FDR")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>% 
  collapse_rows(1:3, valign="top")
```

## GSEA module-level

List genes in each module.

```{r}
enrich.fxn(gene.df = mods.net, 
           df.group="module.char",
           category = "H",
           genome = org.Mm.eg.db, 
           basename = "modules",
           outdir = "results/GSEA/")
```

### GSEA module-level summary

Significant enrichments, FDR $\leq$ 0.2.

```{r warning=FALSE, echo=FALSE, message=FALSE}
GSEA.results2 <- read_csv("results/GSEA/GSEA_modules_H.csv")
  
GSEA.results2 %>% 
  filter(p.adjust<=0.2) %>% 
  dplyr::select(group, size.group,
    Description, size.overlap.term, size.term, 
    p.adjust) %>% 
  arrange(group, p.adjust) %>% 
  
  kable(col.names = c("Module", "Genes in group",
                      "Description", "Genes overlap",
                      "Genes in term",
                      "FDR")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>% 
  collapse_rows(1:2, valign="top")
```

## GSEA module DE groups

Groups are:

1. Up in uninfected only
2. Down in uninfected only
3. Up in infected only
4. Down in infected only
5. Up in both
6. Down in both

### Group genes in module 0

Group genes with FDR < 0.3 in 6 module groups of interest.

```{r}
mod_0 <- Shah_contrast_gene_pval %>% 
  filter(geneName %in% filter(mods.net, module == 0)$geneName &
           adj.P.Val <= 0.3)

mod_0_UI_up <- mod_0 %>% 
  filter(group == "uninfected" & FC.group == "up") %>% 
  dplyr::select(geneName) %>% 
  distinct(geneName) %>%  unlist(use.names = FALSE)
mod_0_UI_down <- mod_0 %>% 
  filter(group == "uninfected" & FC.group == "down") %>% 
  dplyr::select(geneName) %>% 
  distinct(geneName) %>%  unlist(use.names = FALSE)

mod_0_I_up <- mod_0 %>% 
  filter(group == "infected" & FC.group == "up") %>% 
  dplyr::select(geneName) %>% 
  distinct(geneName) %>%  unlist(use.names = FALSE)
mod_0_I_down <- mod_0 %>% 
  filter(group == "infected" & FC.group == "down") %>% 
  dplyr::select(geneName) %>% 
  distinct(geneName) %>%  unlist(use.names = FALSE)

mod_0_both_up <- intersect(mod_0_UI_up, mod_0_I_up)
mod_0_both_down <- intersect(mod_0_UI_down, mod_0_I_down)

mod_0_UI_up2 <- mod_0_UI_up[mod_0_UI_up %notin% 
                          c(mod_0_UI_down,
                            mod_0_I_up, mod_0_I_down)]
mod_0_UI_down2 <- mod_0_UI_down[mod_0_UI_down %notin% 
                           c(mod_0_UI_up,
                            mod_0_I_up, mod_0_I_down)]
  
mod_0_I_up2 <- mod_0_I_up[mod_0_I_up %notin% 
                           c(mod_0_UI_up, mod_0_UI_down,
                            mod_0_I_down)]
mod_0_I_down2 <- mod_0_I_down[mod_0_I_down %notin% 
                            c(mod_0_UI_up, mod_0_UI_down,
                            mod_0_I_up)]
```

Sort genes that have different fold change directions in uninfected vs. infected. If one infection group is significant at FDR < 0.1, use that for grouping.

```{r}
#Check genes not in a group
all <- c(mod_0_UI_up, mod_0_UI_down, mod_0_I_up, mod_0_I_down)
all2 <- c(mod_0_both_up, mod_0_both_down,
          mod_0_UI_up2, mod_0_UI_down2, 
          mod_0_I_up2, mod_0_I_down2)

missing <- mod_0 %>% 
  filter(geneName %in% all[all %notin% all2]) %>% 
  arrange(geneName, adj.P.Val)

#Sort my hand
mod_0_UI_up <- c(mod_0_UI_up2)
mod_0_UI_down <- c(mod_0_UI_down2)
mod_0_I_up <- c(mod_0_I_up2, "ENSMUSG00000024935","ENSMUSG00000027534")
mod_0_I_down <- c(mod_0_I_down2)

#Save lists
save(mod_0_UI_up, mod_0_UI_down, mod_0_I_up, mod_0_I_down,
     mod_0_both_up, mod_0_both_down,
      file="data_clean/module_0_sorted.RData")
```

These leaves 8 module 0 genes which were not grouped into a module FC group because they showed similarly significant but different directions in uninfected and infected groups.

```{r}
missing %>% 
  filter(geneName %notin% c("ENSMUSG00000024935",
                            "ENSMUSG00000027534")) %>% 
  dplyr::select(geneName, mgi_symbol, adj.P.Val, group, FC.group) %>% 
  
 kable() %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>% 
  collapse_rows(columns = 1:2, valign = "top")
```

### Run GSEA

```{r warning=FALSE, message=FALSE, results=FALSE}
#Add groups to modules
mods.net.groups <- mods.net %>% 
  mutate(mod.group = ifelse(module %in% c(14,7,16,9), "both_up",
                      ifelse(module %in% c(5,11,17,10,2), "both_down",
                       ifelse(module %in% c(13,15), "UI_up",
                        ifelse(module %in% c(6,12), "UI_down",
                          ifelse(module %in% c(1,3), "I_up",
                            ifelse(module %in% c(4,8), "I_down",
                                   NA))))))) %>% 
  filter(module != 0)

enrich.fxn(gene.df = mods.net.groups, 
           df.group="mod.group",
           category = "H",
           genome = org.Mm.eg.db, 
           basename = "module_groups",
           outdir = "results/GSEA/")
```

### GSEA module group summary

Significant enrichments, FDR $\leq$ 0.3.

```{r warning=FALSE, echo=FALSE, message=FALSE}
GSEA.result3 <- read_csv("results/GSEA/GSEA_module_groups_H.csv")

GSEA.result3 %>% 
  filter(p.adjust<=0.3) %>% 
  dplyr::select(group, size.group,
    Description, size.overlap.term, size.term, 
    p.adjust) %>% 
  arrange(group, p.adjust) %>% 
  
  kable(col.names = c("Module", "Genes in group",
                      "Description", "Genes overlap",
                      "Genes in term",
                      "FDR")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>% 
  collapse_rows(1:2, valign="top")
```

# R session

```{r}
sessionInfo()
```

***